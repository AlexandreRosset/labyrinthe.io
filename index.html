<!DOCTYPE html>
<html>
 <head>
 	<meta charset="utf-8" />
 	<title>Chat temps réel !</title>
 </head>
 <body ng-app="app" ng-controller="ctrl">
 	<h1>Le Chat temps réel !</h1>
 <section ng-repeat="m in listemessage">
	 [{{m.id}}]: {{m.message}}
 </section>
 <form>
 <input type="text" ng-model="message" placeholder="Votre message..." size="50" autofocus />
<button ng-click="formulaire_chat()">envoyer</button>
</form>
 <!--<script src="http://code.jquery.com/jquery-1.10.1.min.js"></script>-->
 <script src="/socket.io/socket.io.js"></script>
 <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.5.6/angular.js"></script>
 <script>
 var app = angular.module('app', []);

 app.controller('ctrl', function($scope){
	 $scope.listemessage = [];
	 var socket = io.connect('http://10.69.0.43:8080');
	 var pseudo = prompt('Quel est votre pseudo ?');
	 socket.emit('nouveau_client', pseudo);
	 document.title = pseudo + ' - ' + document.title;
	 socket.on('message', function(data) {
	 	insereMessage(data.pseudo, data.message)
	 })
	 socket.on('nouveau_client', function(pseudo) {
	 	insereMessage(pseudo, pseudo + ' a rejoint le Chat !');
	 })
	 $scope.formulaire_chat = function () {
	 socket.emit('message', $scope.message);
	 insereMessage(pseudo, $scope.message);
	 return false;
	 }
	 function insereMessage(pseudo, message) {
	 $scope.message = "";
	 var now = new Date();
	 var i = now.getHours() + ':' + now.getMinutes() + ':' + now.getSeconds();
	 notifyMe("Nouveau message de " + pseudo);
	 $scope.$apply($scope.listemessage.push({'id': i, 'message':'' + pseudo + ' >>> ' + message + ''}));
	 }
	 function notifyMe(mess) {
  if (!("Notification" in window)) {
    alert("Ce navigateur ne supporte pas les notifications desktop");
  }
  else if (Notification.permission === "granted") {
    var notification = new Notification(mess);
  }
  else if (Notification.permission !== 'denied') {
    Notification.requestPermission(function (permission) {
      if(!('permission' in Notification)) {
        Notification.permission = permission;
      }
      if (permission === "granted") {
        var notification = new Notification(mess);
      }
    });
  }
}
 });

 app.filter('reverse', function() {
  return function(items) {
    return items.slice().reverse();
  };
});
 </script>
 </body>
</html>
